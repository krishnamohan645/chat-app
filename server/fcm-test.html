<!doctype html>
<html>
  <head>
    <title>FCM Test - Localhost Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
  </head>
  <body>
    <h1>FCM Token Test</h1>
    <div id="status">Click button to start...</div>
    <br />
    <button onclick="testFCM()">Get FCM Token</button>

    <div id="tokenContainer" style="display: none; margin-top: 20px">
      <h3>Token:</h3>
      <textarea id="token" rows="6" cols="80"></textarea>
      <br />
      <button onclick="copyToken()">Copy</button>
    </div>

    <script>
      // Debug function
      function debug(msg, type = "log") {
        console[type](`[FCM] ${msg}`);
        document.getElementById("status").innerHTML = msg;
      }

      // Check if we're on localhost
      function isLocalhost() {
        return (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        );
      }

      async function testFCM() {
        try {
          debug("Starting...");

          // Check if we're on localhost
          if (!isLocalhost()) {
            debug(
              "⚠️ Warning: Not on localhost. Service workers may be blocked.",
              "warn",
            );
            debug(`Current URL: ${window.location.href}`);
          }

          // 1. Initialize Firebase
          debug("Initializing Firebase...");
          const firebaseConfig = {
            apiKey: "AIzaSyBxCMTEzTUvqcy7FCWh0tQZqph2nXnUYw8",
            authDomain: "chatapp-4a4f0.firebaseapp.com",
            projectId: "chatapp-4a4f0",
            storageBucket: "chatapp-4a4f0.firebasestorage.app",
            messagingSenderId: "139854521979",
            appId: "1:139854521979:web:a2b51882a9809c5a6124de",
            measurementId: "G-KV889K90M3",
          };

          if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
          }

          const messaging = firebase.messaging();
          debug("Firebase initialized");

          // 2. Request permission
          debug("Requesting notification permission...");
          const permission = await Notification.requestPermission();
          debug(`Permission: ${permission}`);

          if (permission !== "granted") {
            debug("❌ Permission denied", "error");
            return;
          }

          // 3. Register service worker WITH ERROR HANDLING
          debug("Registering service worker...");
          let registration;

          // Try multiple paths
          const swPaths = [
            "/firebase-messaging-sw.js",
            "./firebase-messaging-sw.js",
            "firebase-messaging-sw.js",
          ];

          for (const path of swPaths) {
            try {
              debug(`Trying: ${path}`);
              registration = await navigator.serviceWorker.register(path, {
                scope: "./",
                updateViaCache: "none", // Important for dev
              });
              debug(`✅ Service worker registered at: ${path}`);
              break;
            } catch (swError) {
              debug(`❌ Failed ${path}: ${swError.message}`, "error");
              continue;
            }
          }

          if (!registration) {
            debug("❌ All service worker paths failed", "error");
            return;
          }

          // Wait for service worker to be ready
          debug("Waiting for service worker activation...");
          if (registration.installing) {
            await new Promise((resolve) => {
              registration.installing.addEventListener("statechange", (e) => {
                if (e.target.state === "activated") {
                  debug("✅ Service worker activated");
                  resolve();
                }
              });
            });
          }

          // 4. Get token
          debug("Getting FCM token...");
          try {
            // Get VAPID key from Firebase Console
            const vapidKey =
              "BIuv47nGwJ8FBoZkbnXc6ngTtwKsy6lcFLyu4h-p6nu-JJJj2NftjKocYNvy_JB2bIP2gLr5PH5VXj7rmp9_4ig";

            const token = await messaging.getToken({
              vapidKey: vapidKey,
              serviceWorkerRegistration: registration,
            });

            if (token) {
              debug(`✅ TOKEN SUCCESS! Length: ${token.length} chars`);
              console.log("=== YOUR FCM TOKEN ===");
              console.log(token);
              console.log("======================");

              document.getElementById("token").value = token;
              document.getElementById("tokenContainer").style.display = "block";
            } else {
              debug("❌ No token received (empty)", "error");
            }
          } catch (tokenError) {
            debug(`❌ Token error: ${tokenError.message}`, "error");
            console.error("Full error:", tokenError);
          }
        } catch (error) {
          debug(`❌ Unexpected error: ${error.message}`, "error");
          console.error("Full error:", error);
        }
      }

      function copyToken() {
        const token = document.getElementById("token");
        token.select();
        document.execCommand("copy");
        debug("Token copied to clipboard!");
      }

      // Check on load
      window.onload = () => {
        debug('Ready. Click "Get FCM Token" button.');
        console.log("Current hostname:", window.location.hostname);
      };
    </script>
  </body>
</html>
